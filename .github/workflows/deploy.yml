name: Deploy to Vercel

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: staging
    env:
      NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_URL: ${{ secrets.DIRECT_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.9.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify required environment variables
        shell: bash
        run: |
          if [ -z "$DATABASE_URL" ] && [ -z "$DIRECT_URL" ]; then
            echo "Missing DATABASE_URL and DIRECT_URL. Set GitHub secrets (or use Vercel POSTGRES_PRISMA_URL)."
            exit 1
          fi

          node - <<'NODE'
          const raw = process.env.DATABASE_URL || process.env.DIRECT_URL;
          if (!raw) process.exit(0);
          const trimmed = String(raw).trim();
          const unquoted = ((trimmed.startsWith('"') && trimmed.endsWith('"')) || (trimmed.startsWith("'") && trimmed.endsWith("'")))
            ? trimmed.slice(1, -1).trim()
            : trimmed;
          try {
            const u = new URL(unquoted);
            if (u.protocol !== 'postgresql:' && u.protocol !== 'postgres:') throw new Error('Not a postgres URL');
          } catch {
            console.error('DATABASE_URL/DIRECT_URL is present but not a valid postgres URL (common cause: accidental surrounding quotes).');
            process.exit(1);
          }
          NODE

      - name: Run type check
        run: npm run build

      - name: Deploy to Vercel
        run: |
          npx vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }} \
            --env NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="$NEXT_PUBLIC_GOOGLE_MAPS_API_KEY" \
            --env RESEND_API_KEY="$RESEND_API_KEY" \
            --env ADMIN_EMAIL="$ADMIN_EMAIL" \
            --env ADMIN_PASSWORD="$ADMIN_PASSWORD" \
            --env NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
            --env NEXTAUTH_URL="$NEXTAUTH_URL" \
            --env DATABASE_URL="$DATABASE_URL" \
            --env DIRECT_URL="$DIRECT_URL" \
            --build-env NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="$NEXT_PUBLIC_GOOGLE_MAPS_API_KEY" \
            --build-env NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
            --build-env NEXTAUTH_URL="$NEXTAUTH_URL" \
            --build-env DATABASE_URL="$DATABASE_URL" \
            --build-env DIRECT_URL="$DIRECT_URL"

  deploy-prod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    env:
      NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      DIRECT_URL: ${{ secrets.DIRECT_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.9.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify required environment variables
        shell: bash
        run: |
          if [ -z "$DATABASE_URL" ] && [ -z "$DIRECT_URL" ]; then
            echo "Missing DATABASE_URL and DIRECT_URL. Set GitHub secrets (or use Vercel POSTGRES_PRISMA_URL)."
            exit 1
          fi

          node - <<'NODE'
          const raw = process.env.DATABASE_URL || process.env.DIRECT_URL;
          if (!raw) process.exit(0);
          const trimmed = String(raw).trim();
          const unquoted = ((trimmed.startsWith('"') && trimmed.endsWith('"')) || (trimmed.startsWith("'") && trimmed.endsWith("'")))
            ? trimmed.slice(1, -1).trim()
            : trimmed;
          try {
            const u = new URL(unquoted);
            if (u.protocol !== 'postgresql:' && u.protocol !== 'postgres:') throw new Error('Not a postgres URL');
          } catch {
            console.error('DATABASE_URL/DIRECT_URL is present but not a valid postgres URL (common cause: accidental surrounding quotes).');
            process.exit(1);
          }
          NODE

      - name: Run type check
        run: npm run build

      - name: Deploy to Vercel
        run: |
          npx vercel deploy --prod --yes --token=${{ secrets.VERCEL_TOKEN }} \
            --env NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="$NEXT_PUBLIC_GOOGLE_MAPS_API_KEY" \
            --env RESEND_API_KEY="$RESEND_API_KEY" \
            --env ADMIN_EMAIL="$ADMIN_EMAIL" \
            --env ADMIN_PASSWORD="$ADMIN_PASSWORD" \
            --env NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
            --env NEXTAUTH_URL="$NEXTAUTH_URL" \
            --env DATABASE_URL="$DATABASE_URL" \
            --env DIRECT_URL="$DIRECT_URL" \
            --build-env NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="$NEXT_PUBLIC_GOOGLE_MAPS_API_KEY" \
            --build-env NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
            --build-env NEXTAUTH_URL="$NEXTAUTH_URL" \
            --build-env DATABASE_URL="$DATABASE_URL" \
            --build-env DIRECT_URL="$DIRECT_URL"
